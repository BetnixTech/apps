<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Classroom</title>
<style>
body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin:0; padding:0; background:#f1f3f4; color:#202124; }
header { background:#1a73e8; color:white; padding:15px 20px; font-size:1.5em; font-weight:500; }
.container { max-width:1000px; margin:auto; padding:20px; }
button { padding:10px 20px; margin:5px 0; cursor:pointer; border:none; border-radius:8px; background:#4285f4; color:white; }
input, select, textarea { padding:12px; margin:5px 0 15px 0; width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:8px; }
.card { background:white; padding:20px; margin:10px 0; border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.hidden { display:none; }
.submitted { color:green; font-weight:600; }
.graded { color:blue; font-weight:600; }
.dashboard { display:flex; gap:20px; flex-wrap:wrap; }
.dashboard .card { flex:1; min-width:220px; text-align:center; }
</style>
</head>
<body>

<header></header>

<div class="container" id="setupScreen">
  <h2>Welcome</h2>
  <p>Select your role:</p>
  <button id="teacherBtn">Teacher</button>
  <button id="studentBtn">Student</button>
  <div id="studentNameDiv" class="hidden">
    <input type="text" id="studentNameInput" placeholder="Enter your name">
    <button id="studentContinueBtn">Continue</button>
  </div>
</div>

<div class="container hidden" id="teacherDashboard">
  <h2>Teacher Dashboard</h2>
  <div class="dashboard" id="teacherSummary"></div>
  <button onclick="goToTeacherPage()">Manage Classrooms</button>
</div>

<div class="container hidden" id="teacherPage">
  <h2>Classroom Management</h2>
  <select id="teacherClassSelect" onchange="switchTeacherClass()"></select>
  <h3>Create Classroom</h3>
  <input type="text" id="className" placeholder="Classroom Name">
  <button onclick="createClassroom()">Create Classroom</button>
  <p id="teacherClassInfo"></p>

  <h3>Add Assignment</h3>
  <input type="text" id="assignmentTitle" placeholder="Assignment Title">
  <textarea id="assignmentDesc" placeholder="Assignment Description"></textarea>
  <input type="date" id="assignmentDue">
  <button onclick="addAssignment()">Add Assignment</button>

  <h3>Add Material</h3>
  <input type="text" id="materialTitle" placeholder="Material Title">
  <input type="file" id="materialFile">
  <button onclick="addMaterial()">Add Material</button>

  <h3>Assignments & Submissions</h3>
  <div id="teacherAssignments"></div>

  <h3>Classroom Data</h3>
  <button onclick="downloadJSON()">Download JSON Backup</button>
  <button onclick="backToDashboard('teacher')">Back to Dashboard</button>
</div>

<div class="container hidden" id="studentDashboard">
  <h2>Student Dashboard</h2>
  <div class="dashboard" id="studentSummary"></div>
  <button onclick="goToStudentPage()">Go to Classrooms</button>
</div>

<div class="container hidden" id="studentPage">
  <h2>Classrooms</h2>
  <input type="text" id="joinCodeInput" placeholder="Enter Classroom Code">
  <button onclick="joinClass()">Join Classroom</button>
  <select id="studentClassSelect" onchange="switchStudentClass()"></select>

  <h3>Notifications</h3>
  <div id="studentNotifications"></div>

  <h3>Materials</h3>
  <div id="studentMaterials"></div>

  <h3>Assignments</h3>
  <div id="studentAssignments"></div>

  <button onclick="backToDashboard('student')">Back to Dashboard</button>
</div>

<script>
let classrooms = JSON.parse(localStorage.getItem('classrooms')) || [];
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

  
// Safe JSON parsing
function safeParse(key, defaultValue){
  try{
    const data = localStorage.getItem(key);
    if(!data) return defaultValue;
    return JSON.parse(data);
  } catch(e){
    console.warn(`Invalid JSON in localStorage for ${key}, resetting.`);
    return defaultValue;
  }
}

let classrooms = safeParse('classrooms', []);
let currentUser = safeParse('currentUser', null);
let currentClass = null;

function saveData(){ localStorage.setItem('classrooms', JSON.stringify(classrooms)); }

// Setup
function hideSetup(){ document.getElementById('setupScreen').classList.add('hidden'); }
function showTeacherDashboard(){ document.getElementById('teacherDashboard').classList.remove('hidden'); updateTeacherDashboard(); updateTeacherClassSelect(); }
function showStudentDashboard(){ document.getElementById('studentDashboard').classList.remove('hidden'); updateStudentDashboard(); renderStudentClassSelect(); }

document.getElementById('teacherBtn').onclick = ()=>{
  currentUser = {role:'teacher'};
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  hideSetup(); showTeacherDashboard();
};
document.getElementById('studentBtn').onclick = ()=>{ document.getElementById('studentNameDiv').classList.remove('hidden'); };
document.getElementById('studentContinueBtn').onclick = ()=>{
  const name = document.getElementById('studentNameInput').value.trim();
  if(!name){ alert('Enter name'); return; }
  currentUser = {role:'student', name};
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  hideSetup(); showStudentDashboard();
};

// Teacher Functions
function goToTeacherPage(){ document.getElementById('teacherDashboard').classList.add('hidden'); document.getElementById('teacherPage').classList.remove('hidden'); displayTeacherAssignments(); }
function createClassroom(){
  const name = document.getElementById('className').value.trim();
  if(!name) return alert('Enter classroom name');
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  const classroom = {name, code, assignments:[], materials:[], students:[]};
  classrooms.push(classroom); currentClass=classroom; saveData();
  document.getElementById('teacherClassInfo').innerText = `Class Code: ${code}`;
  updateTeacherClassSelect(); displayTeacherAssignments();
}
function addAssignment(){
  if(!currentClass) return alert('Select or create a classroom first');
  const title=document.getElementById('assignmentTitle').value.trim();
  const desc=document.getElementById('assignmentDesc').value.trim();
  const due=document.getElementById('assignmentDue').value;
  if(!title||!desc||!due) return alert('Fill all fields');
  currentClass.assignments.push({title, description:desc, dueDate:due, submissions:[]});
  saveData(); displayTeacherAssignments();
}
function addMaterial(){
  if(!currentClass) return alert('Select or create a classroom first');
  const title=document.getElementById('materialTitle').value.trim();
  const fileInput=document.getElementById('materialFile');
  if(!title||!fileInput.files[0]) return alert('Provide title and file');
  const reader=new FileReader();
  reader.onload=function(e){
    currentClass.materials.push({title, fileName:fileInput.files[0].name, fileData:e.target.result});
    saveData(); displayTeacherAssignments();
  };
  reader.readAsDataURL(fileInput.files[0]);
}
function displayTeacherAssignments(){
  const container=document.getElementById('teacherAssignments'); container.innerHTML='';
  if(!currentClass) return;
  currentClass.materials.forEach((m)=>{ const div=document.createElement('div'); div.className='card'; div.innerHTML=`Material: ${m.title} <a href="${m.fileData}" download="${m.fileName}">Download</a>`; container.appendChild(div); });
  currentClass.assignments.forEach((a)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`Assignment: ${a.title}<br>${a.description}<br>Due: ${a.dueDate}<br>Submissions: ${a.submissions.length}`;
    container.appendChild(div);
  });
}
function updateTeacherDashboard(){
  const container=document.getElementById('teacherSummary'); container.innerHTML='';
  classrooms.forEach(c=>{
    const assignments=c.assignments.length;
    const materials=c.materials.length;
    let pending=0;
    c.assignments.forEach(a=>a.submissions.forEach(s=>{if(!s.grade) pending++}));
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`<h3>${c.name}</h3><p>Assignments: ${assignments}</p><p>Materials: ${materials}</p><p>Pending Grading: ${pending}</p>`;
    container.appendChild(div);
  });
}
function updateTeacherClassSelect(){
  const select=document.getElementById('teacherClassSelect'); select.innerHTML='';
  classrooms.forEach((c,i)=>{
    const option=document.createElement('option'); option.value=i; option.text=c.name+' ('+c.code+')';
    if(currentClass && currentClass.code===c.code) option.selected=true;
    select.appendChild(option);
  });
}
function switchTeacherClass(){ const i=document.getElementById('teacherClassSelect').value; currentClass=classrooms[i]; displayTeacherAssignments(); }
function downloadJSON(){ const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(classrooms,null,2)); const a=document.createElement('a'); a.href=dataStr; a.download="classrooms.json"; document.body.appendChild(a); a.click(); a.remove(); }
function backToDashboard(role){ if(role==='teacher'){ document.getElementById('teacherPage').classList.add('hidden'); showTeacherDashboard(); } else{ document.getElementById('studentPage').classList.add('hidden'); showStudentDashboard(); } }

// Student Functions
function goToStudentPage(){ document.getElementById('studentDashboard').classList.add('hidden'); document.getElementById('studentPage').classList.remove('hidden'); renderStudentClassSelect(); renderStudentAssignments(); renderStudentMaterials(); updateStudentNotifications(); }
function joinClass(){
  const code=document.getElementById('joinCodeInput').value.trim();
  const classroom=classrooms.find(c=>c.code===code); if(!classroom) return alert('Class not found');
  currentClass=classroom;
  if(!currentClass.students.includes(currentUser.name)) currentClass.students.push(currentUser.name);
  saveData(); renderStudentClassSelect(); renderStudentAssignments(); renderStudentMaterials(); updateStudentNotifications(); updateStudentDashboard();
}
function renderStudentClassSelect(){
  const select=document.getElementById('studentClassSelect'); select.innerHTML='';
  classrooms.forEach(c=>{
    if(c.students.includes(currentUser.name)){
      const option=document.createElement('option'); option.value=c.code; option.text=c.name+' ('+c.code+')';
      if(currentClass && currentClass.code===c.code) option.selected=true;
      select.appendChild(option);
    }
  });
}
function switchStudentClass(){
  const code=document.getElementById('studentClassSelect').value;
  const classroom=classrooms.find(c=>c.code===code); if(!classroom) return;
  currentClass=classroom;
  renderStudentAssignments(); renderStudentMaterials(); updateStudentNotifications();
}
function renderStudentMaterials(){
  const container=document.getElementById('studentMaterials'); container.innerHTML='';
  if(!currentClass) return;
  currentClass.materials.forEach(m=>{ const div=document.createElement('div'); div.className='card'; div.innerHTML=`${m.title}: <a href="${m.fileData}" download="${m.fileName}">Download</a>`; container.appendChild(div); });
}
function renderStudentAssignments(){
  const container=document.getElementById('studentAssignments'); container.innerHTML='';
  if(!currentClass) return;
  currentClass.assignments.forEach((a,i)=>{
    const div=document.createElement('div'); div.className='card';
    const submitted=a.submissions.find(s=>s.name===currentUser.name);
    div.innerHTML=`<b>${a.title}</b><br>${a.description}<br>Due: ${a.dueDate}<br>Status: ${submitted?'Submitted':'Not Submitted'}
    <input type="file" id="file_${i}"><button onclick="submitAssignment(${i})">Submit</button>`;
    container.appendChild(div);
  });
}
function submitAssignment(index){
  const input=document.getElementById(`file_${index}`);
  if(!input.files[0]) return alert('Select a file');
  const reader=new FileReader();
  reader.onload=(e)=>{
    const assignment=currentClass.assignments[index];
    const existing=assignment.submissions.find(s=>s.name===currentUser.name);
    if(existing) existing.fileData=e.target.result;
    else assignment.submissions.push({name:currentUser.name, fileData:e.target.result});
    saveData(); renderStudentAssignments(); renderStudentMaterials(); updateStudentNotifications(); updateStudentDashboard();
  };
  reader.readAsDataURL(input.files[0]);
}
function updateStudentNotifications(){
  const container=document.getElementById('studentNotifications'); container.innerHTML='';
  if(!currentClass) return;
  const now=new Date();
  currentClass.assignments.forEach(a=>{
    const due=new Date(a.dueDate);
    const submitted=a.submissions.find(s=>s.name===currentUser.name);
    if(!submitted && (due-now)/(1000*60*60*24)<=3){
      const div=document.createElement('div'); div.className='card'; div.innerHTML=`⚠️ Assignment "${a.title}" is due on ${a.dueDate}`; container.appendChild(div);
    }
  });
}
function updateStudentDashboard(){
  const container=document.getElementById('studentSummary'); container.innerHTML='';
  classrooms.forEach(c=>{
    if(c.students.includes(currentUser.name)){
      const assignments=c.assignments.length;
      let due=0; c.assignments.forEach(a=>{ if(!a.submissions.find(s=>s.name===currentUser.name)) due++; });
      const div=document.createElement('div'); div.className='card';
      div.innerHTML=`<h3>${c.name}</h3><p>Total Assignments: ${assignments}</p><p>Pending Submissions: ${due}</p>`;
      container.appendChild(div);
    }
  });
}

// Auto-load user
if(currentUser){
  hideSetup();
  if(currentUser.role==='teacher') showTeacherDashboard();
  else showStudentDashboard();
}

// Safe JSON parsing for localStorage
function safeParse(key, defaultValue){
  try{
    const data = localStorage.getItem(key);
    if(!data) return defaultValue;
    return JSON.parse(data);
  } catch(e){
    console.warn(`Invalid JSON in localStorage for ${key}, resetting.`);
    return defaultValue;
  }
}

// Usage:
let classrooms = safeParse('classrooms', []);
let currentUser = safeParse('currentUser', null);

  // Display assignments with submissions and grading inputs
function displayTeacherAssignmentsWithGrading(){
  const container = document.getElementById('teacherAssignments');
  container.innerHTML = '';
  if(!currentClass) return;

  currentClass.assignments.forEach((a, aIndex) => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<b>${a.title}</b><br>${a.description}<br>Due: ${a.dueDate}<br>`;

    if(a.submissions.length === 0){
      div.innerHTML += 'No submissions yet.';
    } else {
      a.submissions.forEach((s, sIndex) => {
        div.innerHTML += `
          <p>${s.name} 
            ${s.grade ? `<span class="graded">Grade: ${s.grade}</span>` : ''}
            <button onclick="gradeSubmission(${aIndex}, ${sIndex})">Grade</button>
          </p>
        `;
      });
    }
    container.appendChild(div);
  });
}

// Prompt teacher to grade a submission
function gradeSubmission(assignmentIndex, submissionIndex){
  const grade = prompt("Enter grade for this submission (e.g., 90/100):");
  if(grade !== null){
    currentClass.assignments[assignmentIndex].submissions[submissionIndex].grade = grade;
    saveData();
    displayTeacherAssignmentsWithGrading();
  }
}

// Show student's grades in assignments
function renderStudentAssignmentsWithGrades(){
  const container = document.getElementById('studentAssignments');
  container.innerHTML = '';
  if(!currentClass) return;

  currentClass.assignments.forEach((a, i) => {
    const submitted = a.submissions.find(s => s.name === currentUser.name);
    const gradeText = submitted && submitted.grade ? `<br><span class="graded">Grade: ${submitted.grade}</span>` : '';
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<b>${a.title}</b><br>${a.description}<br>Due: ${a.dueDate}<br>Status: ${submitted ? 'Submitted' : 'Not Submitted'}${gradeText}
      <input type="file" id="file_${i}"><button onclick="submitAssignment(${i})">Submit</button>`;
    container.appendChild(div);
  });
}

</script>
</body>
</html>
